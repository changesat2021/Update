<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Floating Money - Waiters</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --white: #fff; --radius: 10px; }
        body { margin: 0; font-family: sans-serif; background: #eef2f3; padding: 10px; }
        .container { max-width: 650px; margin: 0 auto; }
        header { background: var(--primary); color: white; padding: 15px; border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .add-card { background: var(--white); padding: 15px; border-radius: var(--radius); box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 5px solid var(--accent); }
        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .btn-add { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 5px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .record { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .paid-row { opacity: 0.5; background: #f0f0f0; }
        .btn-pay { background: #27ae60; color: white; border: none; padding: 8px 12px; border-radius: 4px; }
        .btn-del { background: #c0392b; color: white; border: none; padding: 8px 12px; border-radius: 4px; display: none; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <a href="index.html" style="text-decoration:none; font-weight:bold; color:var(--primary);">‚Üê Back to POS</a>

    <header>
        <h3 style="margin:0;">üí≥ Floating Money</h3>
        <input type="date" id="filter-date" style="max-width: 150px;">
    </header>

    <div class="add-card">
        <div class="input-row">
            <input type="text" id="c-name" placeholder="Customer Name">
            <input type="number" id="c-amt" placeholder="Amount (ETB)">
        </div>
        <div class="input-row">
            <input type="text" id="c-reason" placeholder="Reason (e.g. Lunch)">
        </div>
        <button class="btn-add" onclick="addFloat()">Save Debt</button>
    </div>

    <div id="float-list"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAKqsixs_luzjqCY1ZCqrKRtn77wcJs5Iw",
        authDomain: "bean-5a113.firebaseapp.com",
        projectId: "bean-5a113",
        storageBucket: "bean-5a113.firebasestorage.app",
        messagingSenderId: "702927377502",
        appId: "1:702927377502:web:9e50192a0c431da69850cf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(), auth = firebase.auth();
    const adminUID = "Mo1oHKdvskXeuRjY8h1YFMT5vrl2";
    
    let isAdmin = false;

    window.onload = () => {
        document.getElementById('filter-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('filter-date').onchange = loadData;
        loadData();

        auth.onAuthStateChanged(user => {
            isAdmin = (user && user.uid === adminUID);
            loadData(); 
        });
    };

    async function addFloat() {
        const name = document.getElementById('c-name').value;
        const amt = parseFloat(document.getElementById('c-amt').value);
        const reason = document.getElementById('c-reason').value;
        const date = document.getElementById('filter-date').value;

        if(!name || !amt) return alert("Enter Name and Amount");

        try {
            await db.collection('floating_money').add({
                customerName: name,
                amount: amt,
                reason: reason || "Unspecified",
                date: date,
                status: 'unpaid',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // Clear inputs
            document.getElementById('c-name').value = '';
            document.getElementById('c-amt').value = '';
            document.getElementById('c-reason').value = '';
            alert("Debt Saved!");
        } catch(e) {
            console.error(e);
            alert("Database Error: Ensure you updated your Rules in Firebase Console.");
        }
    }

    function loadData() {
        const date = document.getElementById('filter-date').value;
        db.collection('floating_money').where('date', '==', date).orderBy('createdAt', 'desc')
          .onSnapshot(snap => {
              let html = '';
              snap.forEach(doc => {
                  const d = doc.data();
                  const isPaid = d.status === 'paid';
                  html += `
                  <div class="record ${isPaid ? 'paid-row' : ''}">
                      <div>
                          <strong>${d.customerName}</strong>: ${d.amount} ETB<br>
                          <small>${d.reason}</small>
                      </div>
                      <div style="text-align:right">
                          ${!isPaid ? `<button class="btn-pay" onclick="markPaid('${doc.id}')">Mark Paid</button>` : '‚úÖ Paid'}
                          ${isAdmin ? `<button class="btn-del" style="display:block" onclick="deleteRec('${doc.id}')">Delete</button>` : ''}
                      </div>
                  </div>`;
              });
              document.getElementById('float-list').innerHTML = html;
          });
    }

    async function markPaid(id) {
        if(confirm("Collect money?")) await db.collection('floating_money').doc(id).update({ status: 'paid' });
    }

    async function deleteRec(id) {
        if(confirm("Admin Delete?")) await db.collection('floating_money').doc(id).delete();
    }
</script>
</body>
</html>
