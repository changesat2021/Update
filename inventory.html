<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Control - Admin</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        :root { --primary: #6F4E37; --danger: #c0392b; --warning: #f1c40f; --success: #27ae60; --white: #fff; --radius: 10px; }
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; max-width: 800px; margin: 0 auto; }
        
        h2, h3 { color: var(--primary); border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        
        .card { background: var(--white); padding: 20px; border-radius: var(--radius); box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Forms */
        .form-group { margin-bottom: 10px; display: grid; gap: 5px; }
        input, select, button { padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: var(--primary); color: white; border: none; font-weight: bold; }
        button:hover { opacity: 0.9; }
        .btn-danger { background: var(--danger); }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #eee; }
        
        /* Indicators */
        .status-ok { border-left: 5px solid var(--success); }
        .status-low { border-left: 5px solid var(--warning); background: #fffcf0; }
        .status-out { border-left: 5px solid var(--danger); background: #fff0f0; }

        .nav-link { display: inline-block; margin-bottom: 15px; color: var(--primary); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <a href="index.html" class="nav-link">‚Üê Back to POS</a>
    
    <div id="auth-check" style="display:none; text-align:center; padding:50px;">
        <h2>Access Denied</h2>
        <p>Verifying Credentials...</p>
        <a href="index.html">Go Back</a>
    </div>

    <div id="admin-panel" style="display:none;">
        <h2>üì¶ Inventory Management (Admin)</h2>

        <div class="card">
            <h3>Add / Restock Material</h3>
            <div class="form-group" style="grid-template-columns: 2fr 1fr 1fr 1fr;">
                <input type="text" id="mat-name" placeholder="Name (e.g. Coffee Beans)">
                <input type="text" id="mat-unit" placeholder="Unit (kg, L)">
                <input type="number" id="mat-cap" placeholder="Servings per Unit">
                <input type="number" id="mat-qty" placeholder="Qty to Add">
            </div>
            <button onclick="addMaterial()">Update / Add Stock</button>
        </div>

        <div class="card">
            <h3>Recipe Mapper</h3>
            <p style="font-size:0.8rem; color:#666;">Link a POS Menu Item to a Raw Material.</p>
            <div class="form-group" style="grid-template-columns: 2fr 2fr 1fr auto;">
                <select id="recipe-item"></select>
                <select id="recipe-mat"></select>
                <input type="number" id="recipe-deduct" value="1" placeholder="Deduct count">
                <button onclick="saveRecipe()">Link</button>
            </div>
            <div id="active-recipes" style="margin-top:10px; font-size:0.8rem;"></div>
        </div>

        <div class="card">
            <h3>Current Stock Levels</h3>
            <table>
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Raw Qty</th>
                        <th>Rem. Servings</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="inventory-list"></tbody>
            </table>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAKqsixs_luzjqCY1ZCqrKRtn77wcJs5Iw",
        authDomain: "bean-5a113.firebaseapp.com",
        projectId: "bean-5a113",
        storageBucket: "bean-5a113.firebasestorage.app",
        messagingSenderId: "702927377502",
        appId: "1:702927377502:web:9e50192a0c431da69850cf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(), auth = firebase.auth();
    const adminUID = "Mo1oHKdvskXeuRjY8h1YFMT5vrl2";

    const POS_MENU = [
        '·â°·äì', '·àª·ã≠', '·àà·ãç·ãù', '·ãà·â∞·âµ', '·àõ·ä™·ã´·â∂', '·âÄ·àΩ·à≠', '·àµ·çï·à™·àµ',
        '·àà·àµ·àã·à≥', '·ãç·àÉ 2 ·àä·âµ·à≠', '·ãç·àÉ 1 ·àä·âµ·à≠', '·ãç·àÉ ·åç·àõ·àΩ',
        '·ä†·âÆ·ä´·ã∂ ·åÅ·àµ', '·àõ·äï·åé ·åÅ·àµ', '·çì·çì·ã´ ·åÅ·àµ', '·àô·ãù ·åÅ·àµ', '·ä†·äì·äì·àµ', '·â∞·àç·â£ ·åÅ·àµ', '·â†·à∂ ·åÅ·àµ', '·ãà·â∞·âµ ·â†·ä†·âÆ·ä´·ã∂', '·àµ·çî·àª·àç ·åÅ·àµ',
        '·çì·àµ·â≥ ·â†·àµ·åé', '·àΩ·àÆ', '·â∞·åã·â¢·äñ', '·àΩ·àÆ ·â†·à∞·àã·å£', '·çç·à≠·çç·à≠', '·àÉ·çç ·àÉ·çç', '·çâ·àç ·äñ·à≠·àõ·àç', '·çâ·àç ·â†·ä†·âÆ·ä´·ã∂', '·çâ·àç ·â†·ä•·äï·âÅ·àã·àç', '·â≤·àõ·â≤·àù ·àà·â•·àà·â•', '·â†·ã´·ã≠·äê·âµ', '·çé·à∂·àä·ã´', '·ä†·ãö·çã', '·â∫·çï·àµ 25', '·â∫·çï·àµ 35', '·â∫·çï·àµ 80', '·ä•·à≠·å•·â•', '·ä•·à≠·å•·â• ·àµ·çî·àª·àç', '·çì·àµ·â≥ ·â†·ä†·âµ·ä≠·àç·âµ', '·à©·ãù ·â†·ä†·âµ·ä≠·àç·âµ',
        '·å•·â•·àµ', '·àµ·åã ·çç·à≠·çç·à≠', '·çì·àµ·â≥ ·â†·àµ·åã', '·çì·àµ·â≥ ·â† ·ä•·äï·âÅ·àã·àç', '·ä•·äï·âÅ·àã·àç ·à≥·äï·ãµ·ãä·âΩ', '·å•·â•·àµ ·çç·à≠·çç·à≠', '·ä•·äï·âÅ·àã·àç ·â†·àµ·åã', '·ä•·äï·âÅ·àã·àç ·çç·à≠·çç·à≠', '·âã·äï·å£ ·çç·à≠·çç·à≠', '·çâ·àç ·â†·âÖ·â§', '·àΩ·àÆ ·â†·âÖ·â§'
    ];

    window.onload = () => {
        auth.onAuthStateChanged(user => {
            if(user && user.uid === adminUID) {
                document.getElementById('admin-panel').style.display = 'block';
                init();
            } else {
                document.getElementById('auth-check').style.display = 'block';
                document.getElementById('auth-check').innerHTML = `<h2>Access Denied</h2><p>Restricted to Admin Only.</p><a href="index.html">Go Back</a>`;
            }
        });
    };

    function init() {
        loadInventory();
        loadRecipes();
        
        const itemSel = document.getElementById('recipe-item');
        POS_MENU.sort().forEach(m => {
            let opt = document.createElement('option');
            opt.value = m; opt.innerText = m;
            itemSel.appendChild(opt);
        });
    }

    // --- INVENTORY LOGIC ---
    function loadInventory() {
        db.collection('inventory').orderBy('name').onSnapshot(snap => {
            let html = '';
            const matSel = document.getElementById('recipe-mat');
            matSel.innerHTML = ''; 

            snap.forEach(doc => {
                const d = doc.data();
                
                // Populate Dropdown
                let opt = document.createElement('option');
                opt.value = doc.id; opt.innerText = d.name;
                matSel.appendChild(opt);

                let statusClass = 'status-ok';
                if(d.remainingServings <= 0) statusClass = 'status-out';
                else if(d.remainingServings < (d.servingCapacity * 0.2)) statusClass = 'status-low';

                html += `
                <tr class="${statusClass}">
                    <td><strong>${d.name}</strong><br><small>${d.unit}</small></td>
                    <td>${d.quantity.toFixed(2)}</td>
                    <td>${d.remainingServings.toFixed(1)} / ${d.servingCapacity}</td>
                    <td><button class="btn-danger" style="padding:5px;" onclick="deleteMat('${doc.id}')">Del</button></td>
                </tr>`;
            });
            document.getElementById('inventory-list').innerHTML = html;
        });
    }

    async function addMaterial() {
        const name = document.getElementById('mat-name').value.trim();
        const unit = document.getElementById('mat-unit').value;
        const cap = parseFloat(document.getElementById('mat-cap').value);
        const qty = parseFloat(document.getElementById('mat-qty').value);

        if(!name || !cap || !qty) return alert("Fill all fields");

        const snap = await db.collection('inventory').where('name', '==', name).limit(1).get();
        const addedServings = qty * cap;

        if(!snap.empty) {
            const doc = snap.docs[0];
            await doc.ref.update({
                quantity: firebase.firestore.FieldValue.increment(qty),
                remainingServings: firebase.firestore.FieldValue.increment(addedServings),
                servingCapacity: cap, 
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            await db.collection('inventory').add({
                name: name,
                unit: unit,
                quantity: qty,
                servingCapacity: cap,
                remainingServings: addedServings,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        document.getElementById('mat-name').value = '';
        document.getElementById('mat-qty').value = '';
    }

    async function deleteMat(id) {
        if(confirm("Permanently delete this material?")) {
            await db.collection('inventory').doc(id).delete();
        }
    }

    // --- RECIPE LOGIC ---
    async function saveRecipe() {
        const item = document.getElementById('recipe-item').value;
        const matId = document.getElementById('recipe-mat').value;
        const deduct = parseFloat(document.getElementById('recipe-deduct').value);

        if(!matId) return alert("No material selected");

        const snap = await db.collection('recipes').where('itemName', '==', item).get();
        let materials = [], docRef = null;

        if(!snap.empty) {
            docRef = snap.docs[0].ref;
            materials = snap.docs[0].data().materials || [];
        }

        materials = materials.filter(m => m.materialId !== matId);
        materials.push({ materialId: matId, deductionPerSale: deduct });

        if(docRef) await docRef.update({ materials: materials });
        else await db.collection('recipes').add({ itemName: item, materials: materials });
    }

    function loadRecipes() {
        db.collection('recipes').onSnapshot(snap => {
            let html = '<strong>Active Recipes:</strong><br>';
            snap.forEach(doc => {
                const d = doc.data();
                html += `Item: <b>${d.itemName}</b> uses ${d.materials.length} material(s) <button onclick="clearRecipe('${doc.id}')" style="font-size:0.6rem; width:auto; padding:2px 5px; background:red;">X</button><br>`;
            });
            document.getElementById('active-recipes').innerHTML = html;
        });
    }

    async function clearRecipe(id) {
        if(confirm("Delete this recipe?")) await db.collection('recipes').doc(id).delete();
    }
</script>
</body>
</html>
