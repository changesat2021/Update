<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bean Caf√© Management</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root { --primary: #4a2c2a; --accent: #d4a373; --light: #fefae0; --success: #2d6a4f; --danger: #bc4749; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: #f4f4f4; color: #333; padding-bottom: 50px; }
        .header { background: var(--primary); color: white; padding: 1rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .container { max-width: 800px; margin: auto; padding: 10px; }
        
        /* Layout Grid */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding: 10px; }
        .menu-btn { background: white; border: 1px solid #ddd; padding: 15px 5px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .menu-btn:active { transform: scale(0.95); background: var(--accent); }
        .food-btn { border-left: 5px solid var(--success); }
        .add-btn { border-left: 5px solid var(--accent); }

        /* Accordion */
        .accordion { background-color: #eee; color: #444; cursor: pointer; padding: 15px; width: 100%; border: none; text-align: left; outline: none; font-size: 16px; font-weight: bold; transition: 0.4s; border-radius: 5px; margin-top: 10px; display: flex; justify-content: space-between; }
        .active, .accordion:hover { background-color: #ccc; }
        .panel { padding: 0 10px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-radius: 0 0 5px 5px; }
        .panel.show { padding: 10px; border: 1px solid #eee; border-top: none; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f8f8f8; }
        .stock-curr { font-weight: bold; color: var(--primary); background: #fff9f0; }

        /* Admin Controls */
        .admin-section { background: #fff; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #ddd; }
        .stat-card { background: var(--primary); color: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* Modal */
        #qty-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:1000; }
        .modal-content { background:white; padding:30px; border-radius:10px; text-align:center; width: 80%; max-width: 300px; }
        input[type="number"], input[type="text"] { width: 80%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-main { background: var(--success); color: white; width: 100%; }
        .btn-outline { background: transparent; border: 1px solid white; color: white; font-size: 0.8rem; }
        
        .inv-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .inv-in { width: 60px !important; margin: 0 !important; padding: 5px !important; }
        .inv-btn { background: var(--success); color: white; border: none; padding: 5px 10px; border-radius: 3px; }

        .admin-edit-link { color: blue; text-decoration: underline; cursor: pointer; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .panel { max-height: none !important; overflow: visible !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>

<div class="header no-print">
    <div style="font-weight: bold;">BEAN CAF√â</div>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="date" id="work-date" style="padding: 5px; border-radius: 4px; border: none;">
        <button class="btn-outline" id="auth-btn" onclick="handleAuth()">Admin</button>
    </div>
</div>

<div class="container">
    
    <button class="accordion no-print">‚òï Hot Drinks <span>+</span></button>
    <div class="panel"><div class="menu-grid" id="grid-hot"></div></div>

    <button class="accordion no-print">üçπ Juices <span>+</span></button>
    <div class="panel"><div class="menu-grid" id="grid-juices"></div></div>

    <button class="accordion no-print">ü•ó Fasting Food <span>+</span></button>
    <div class="panel"><div class="menu-grid" id="grid-fasting"></div></div>

    <button class="accordion no-print">ü•© Non-Fasting Food <span>+</span></button>
    <div class="panel"><div class="menu-grid" id="grid-nonfast"></div></div>

    <button class="accordion no-print">ü•ñ Extras <span>+</span></button>
    <div class="panel"><div class="menu-grid" id="grid-add"></div></div>

    <div class="admin-section">
        <h3 style="margin-top:0;">Daily Summary</h3>
        <div class="grid-2">
            <div class="stat-card" style="background:#2d6a4f;">Sales: <br><span id="total-s">0</span> ETB</div>
            <div class="stat-card" style="background:#bc4749;">Expenses: <br><span id="total-e">0</span> ETB</div>
        </div>
        <div class="stat-card" style="background:#4a2c2a; text-align: center;">
            Net Cash: <br><span id="total-n" style="font-size: 1.5rem;">0 ETB</span>
        </div>

        <table id="daily-log-table">
            <thead>
                <tr><th>Item</th><th>Qty</th><th>Total</th><th class="no-print">Action</th></tr>
            </thead>
            <tbody id="log-body"></tbody>
        </table>

        <div class="grid-2 no-print" style="margin-top: 15px;">
            <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                <small>Manual Expense</small>
                <input type="text" id="ex-name" placeholder="Item Name" style="width: 90%;">
                <input type="number" id="ex-amt" placeholder="Amount" style="width: 90%;">
                <button class="btn-main" onclick="saveEx()" style="background:var(--danger)">Save Expense</button>
            </div>
            <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                <small>Manual Income</small>
                <input type="text" id="rev-name" placeholder="Item Name" style="width: 90%;">
                <input type="number" id="rev-amt" placeholder="Amount" style="width: 90%;">
                <button class="btn-main" onclick="saveRev()">Save Income</button>
            </div>
        </div>
    </div>

    <div class="admin-section" id="admin-stock-wrapper">
        <h3>Live Stock Tracking</h3>
        <table>
            <thead>
                <tr><th>Item</th><th>Yesterday</th><th>In</th><th>Used</th><th>LEFT</th></tr>
            </thead>
            <tbody id="live-inv-body"></tbody>
        </table>
        
        <div class="no-print">
            <h4>Restock Items</h4>
            <div id="restock-container"></div>
        </div>
    </div>

    <div class="admin-section">
        <h3>Incentive Calculator</h3>
        <p>Total Food Plates: <strong id="total-plates">0</strong></p>
        
        <div id="admin-manual-control" class="grid-2 no-print" style="background: #fff3e0; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: none;">
            <div>
                <small>Night Food Qty:</small>
                <input type="number" id="manual-night-food" value="0">
            </div>
            <div>
                <small>Night Buna Qty:</small>
                <input type="number" id="manual-night-buna" value="0">
            </div>
            <div style="grid-column: span 2;">
                <label><input type="checkbox" id="absent-amelewerk"> Amelewerk Absent (Night)</label><br>
                <label><input type="checkbox" id="absent-frehiwot"> Frehiwot Absent (Night)</label>
            </div>
            <button class="btn-main" style="grid-column: span 2;" onclick="saveNightStats()">Update Night Stats</button>
        </div>

        <div style="background: #e9ecef; padding: 15px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between;">
                <span>Daily Incentive:</span>
                <strong id="daily-incentive">0.00</strong>
            </div>
            <hr>
            <div style="font-size: 0.8rem; color: #666;">
                Normal Hours Share: <span id="d-inc-norm">0</span> ETB<br>
                Night Shift Share: <span id="d-inc-night">0</span> ETB
            </div>
        </div>
    </div>

    <div class="admin-section" id="admin-month-card" style="display:none; background: #2d3436; color: white;">
        <h3>Monthly Performance</h3>
        <p>Month Net Cash: <span id="month-n">0 ETB</span></p>
        <p>Month Total Incentive: <span id="month-incentive">0 ETB</span></p>
        <hr>
        <p>Amelewerk Balance (Deductions): <span id="bal-ame">0</span> ETB</p>
        <p>Frehiwot Balance (Deductions): <span id="bal-fre">0</span> ETB</p>
    </div>

    <div id="restock-log-container" class="admin-section no-print">
        <h3>Today's Restocks</h3>
        <table>
            <thead><tr><th>Item</th><th>Qty</th><th>Action</th></tr></thead>
            <tbody id="restock-log-body"></tbody>
        </table>
    </div>

    <button class="btn-main no-print" id="print-btn" onclick="initiateFinalize()" style="margin-top: 20px; background: #000; display: none;">Finalize Day & Print Report</button>
</div>

<div class="print-only" style="padding: 20px;">
    <h2 style="text-align: center;">BEAN CAF√â - DAILY REPORT</h2>
    <p id="pdf-date" style="text-align: center;"></p>
    <hr>
    <h3>Inventory Status</h3>
    <table>
        <thead><tr><th>Item</th><th>Start (Yest+In)</th><th>Used</th><th>Actual Left</th></tr></thead>
        <tbody id="print-inv-body"></tbody>
    </table>
    <div style="margin-top: 40px; display: flex; justify-content: space-between;">
        <div>____________________<br>Manager Signature</div>
        <div>____________________<br>Stock Keeper Signature</div>
    </div>
</div>

<div id="qty-modal">
    <div class="modal-content">
        <h3 id="m-item">Item</h3>
        <input type="number" id="m-qty" value="1" min="1">
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-main" onclick="confirmSale()" style="flex:2">Confirm</button>
            <button class="btn" onclick="closeModal()" style="background:#eee; flex:1">Cancel</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAKqsixs_luzjqCY1ZCqrKRtn77wcJs5Iw",
        authDomain: "bean-5a113.firebaseapp.com",
        projectId: "bean-5a113",
        storageBucket: "bean-5a113.firebasestorage.app",
        messagingSenderId: "702927377502",
        appId: "1:702927377502:web:9e50192a0c431da69850cf"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(), auth = firebase.auth();
    const adminUID = "Mo1oHKdvskXeuRjY8h1YFMT5vrl2";

    const MENU = [
        { n: '·â°·äì', p: 40, c: 'hot' }, { n: '·àª·ã≠', p: 25, c: 'hot' }, { n: '·àà·ãç·ãù', p: 50, c: 'hot' }, { n: '·ãà·â∞·âµ', p: 70, c: 'hot' }, { n: '·àõ·ä™·ã´·â∂', p: 60, c: 'hot' }, { n: '·âÄ·àΩ·à≠', p: 50, c: 'hot' }, { n: '·àµ·çï·à™·àµ', p: 50, c: 'hot' },
        { n: '·àà·àµ·àã·à≥', p: 50, c: 'hot' }, { n: '·ãç·àÉ 2 ·àä·âµ·à≠', p: 40, c: 'hot' }, { n: '·ãç·àÉ 1 ·àä·âµ·à≠', p: 35, c: 'hot' }, { n: '·ãç·àÉ ·åç·àõ·àΩ', p: 25, c: 'hot' },
        { n: '·ä†·âÆ·ä´·ã∂ ·åÅ·àµ', p: 120, c: 'juices' }, { n: '·àõ·äï·åé ·åÅ·àµ', p: 120, c: 'juices' }, { n: '·çì·çì·ã´ ·åÅ·àµ', p: 120, c: 'juices' }, { n: '·àô·ãù ·åÅ·àµ', p: 120, c: 'juices' }, { n: '·ä†·äì·äì·àµ', p: 120, c: 'juices' }, { n: '·â∞·àç·â£ ·åÅ·àµ', p: 120, c: 'juices' }, { n: '·â†·à∂ ·åÅ·àµ', p: 120, c: 'juices' }, { n: '·ãà·â∞·âµ ·â†·ä†·âÆ·ä´·ã∂', p: 200, c: 'juices' }, { n: '·àµ·çî·àª·àç ·åÅ·àµ', p: 250, c: 'juices' },
        { n: '·çì·àµ·â≥ ·â†·àµ·åé', p: 130, c: 'fasting' }, { n: '·àΩ·àÆ', p: 120, c: 'fasting' }, { n: '·â∞·åã·â¢·äñ', p: 130, c: 'fasting' }, { n: '·àΩ·àÆ ·â†·à∞·àã·å£', p: 180, c: 'fasting' }, { n: '·àÉ·çç ·àÉ·çç', p: 150, c: 'fasting' }, { n: '·çç·à≠·çç·à≠', p: 100, c: 'fasting' }, { n: '·çâ·àç ·äñ·à≠·àõ·àç', p: 90, c: 'fasting' }, { n: '·çâ·àç ·â†·ä†·âÆ·ä´·ã∂', p: 90, c: 'fasting' }, { n: '·çâ·àç ·â†·ä•·äï·âÅ·àã·àç', p: 120, c: 'fasting' }, { n: '·â≤·àõ·â≤·àù ·àà·â•·àà·â•', p: 100, c: 'fasting' }, { n: '·â†·ã´·ã≠·äê·âµ', p: 140, c: 'fasting' }, { n: '·çé·à∂·àä·ã´', p: 160, c: 'fasting' }, { n: '·ä†·ãö·çã', p: 160, c: 'fasting' }, { n: '·â∫·çï·àµ 25', p: 25, c: 'fasting' }, { n: '·â∫·çï·àµ 35', p: 35, c: 'fasting' }, { n: '·â∫·çï·àµ 80', p: 80, c: 'fasting' }, { n: '·ä•·à≠·å•·â•', p: 90, c: 'fasting' }, { n: '·ä•·à≠·å•·â• ·àµ·çî·àª·àç', p: 120, c: 'fasting' }, { n: '·çì·àµ·â≥ ·â†·ä†·âµ·ä≠·àç·âµ', p: 140, c: 'fasting' }, { n: '·à©·ãù ·â†·ä†·âµ·ä≠·àç·âµ', p: 140, c: 'fasting' },
        { n: '·å•·â•·àµ', p: 270, c: 'nonfast' }, { n: '·àµ·åã ·çç·à≠·çç·à≠', p: 250, c: 'nonfast' }, { n: '·çì·àµ·â≥ ·â†·àµ·åã', p: 250, c: 'nonfast' }, { n: '·çì·àµ·â≥ ·â† ·ä•·äï·âÅ·àã·àç', p: 200, c: 'nonfast' }, { n: '·ä•·äï·âÅ·àã·àç ·à≥·äï·ãµ·ãä·âΩ', p: 120, c: 'nonfast' }, { n: '·å•·â•·àµ ·çç·à≠·çç·à≠', p: 300, c: 'nonfast' }, { n: '·ä•·äï·âÅ·àã·àç ·â†·àµ·åã', p: 250, c: 'nonfast' }, { n: '·ä•·äï·âÅ·àã·àç ·çç·à≠·çç·à≠', p: 140, c: 'nonfast' }, { n: '·âã·äï·å£ ·çç·à≠·çç·à≠', p: 300, c: 'nonfast' }, { n: '·çâ·àç ·â†·âÖ·â§', p: 140, c: 'nonfast' }, { n: '·àΩ·àÆ ·â†·âÖ·â§', p: 180, c: 'nonfast' },
        { n: '·ã≥·â¶', p: 15, c: 'add' }, { n: '·åç·àõ·àΩ ·ä•·äï·åÄ·à´', p: 20, c: 'add' }, { n: '·ä•·äï·åÄ·à´', p: 35, c: 'add' }, { n: '·ä†·àù·â£·àª', p: 30, c: 'add' }, { n: '·à≥·àù·â°·à≥', p: 25, c: 'add' }, { n: '·â•·àµ·ä©·âµ', p: 25, c: 'add' }, { n: '·â¥·ä´·ãå ·ä®·çï', p: 15, c: 'add' }, 
        { n: '·ä•·äï·âÅ·àã·àç ·âÖ·âÖ·àç', p: 30, c: 'add' }
    ];

    const INVENTORY_ITEMS = [ "·ãç·àÉ ·åç·àõ·àΩ", "·ãç·àÉ 1 ·àä·âµ·à≠", "·ãç·àÉ 2 ·àä·âµ·à≠", "·àà·àµ·àã·à≥", "·ä•·äï·åÄ·à´", "·ã≥·â¶", "·ä•·äï·âÅ·àã·àç", "·ã®·å•·â•·àµ ·àµ·åã", "·ã®·ã±·àà·âµ ·àµ·åã", "·ã®·âã·äï·å£ ·àµ·åã", "·çì·àµ·â≥ ·â†·çê·à≠·à∞·äï·âµ", "·â°·äì ·â†·çê·à≠·à∞·äï·âµ" ];
    const FOOD_SET = new Set(MENU.filter(i => i.c === 'fasting' || i.c === 'nonfast').map(i => i.n));
    const MANUAL_LINK_ITEMS = ['·ä•·äï·åÄ·à´', '·ã≥·â¶'];

    const RECIPES = {
        '·â°·äì': [{ i: '·â°·äì ·â†·çê·à≠·à∞·äï·âµ', q: 1/96 }],
        '·ãç·àÉ ·åç·àõ·àΩ': [{ i: '·ãç·àÉ ·åç·àõ·àΩ', q: 1 }], '·ãç·àÉ 1 ·àä·âµ·à≠': [{ i: '·ãç·àÉ 1 ·àä·âµ·à≠', q: 1 }], '·ãç·àÉ 2 ·àä·âµ·à≠': [{ i: '·ãç·àÉ 2 ·àä·âµ·à≠', q: 1 }],
        '·àà·àµ·àã·à≥': [{ i: '·àà·àµ·àã·à≥', q: 1 }], '·çì·àµ·â≥ ·â†·àµ·åé': [{ i: '·çì·àµ·â≥ ·â†·çê·à≠·à∞·äï·âµ', q: 1/5 }],
        '·çì·àµ·â≥ ·â†·àµ·åã': [{ i: '·çì·àµ·â≥ ·â†·çê·à≠·à∞·äï·âµ', q: 1/5 }], '·çì·àµ·â≥ ·â†·ä†·âµ·ä≠·àç·âµ': [{ i: '·çì·àµ·â≥ ·â†·çê·à≠·à∞·äï·âµ', q: 1/6 }],
        '·àÉ·çç ·àÉ·çç': [{ i: '·çì·àµ·â≥ ·â†·çê·à≠·à∞·äï·âµ', q: 1/12 }], '·çì·àµ·â≥ ·â† ·ä•·äï·âÅ·àã·àç': [{ i: '·çì·àµ·â≥ ·â†·çê·à≠·à∞·äï·âµ', q: 1/5 }, { i: '·ä•·äï·âÅ·àã·àç', q: 2 }],
        '·ä•·äï·âÅ·àã·àç ·â†·àµ·åã': [{ i: '·ã®·å•·â•·àµ ·àµ·åã', q: 1/10 }, { i: '·ä•·äï·âÅ·àã·àç', q: 2 }], '·ä•·äï·âÅ·àã·àç ·à≥·äï·ãµ·ãä·âΩ': [{ i: '·ä•·äï·âÅ·àã·àç', q: 2 }],
        '·ä•·äï·âÅ·àã·àç ·çç·à≠·çç·à≠': [{ i: '·ä•·äï·âÅ·àã·àç', q: 2 }], '·ä•·äï·âÅ·àã·àç ·âÖ·âÖ·àç': [{ i: '·ä•·äï·âÅ·àã·àç', q: 1 }],
        '·âã·äï·å£ ·çç·à≠·çç·à≠': [{ i: '·ã®·âã·äï·å£ ·àµ·åã', q: 1/6 }], '·å•·â•·àµ': [{ i: '·ã®·å•·â•·àµ ·àµ·åã', q: 1/7 }],
        '·å•·â•·àµ ·çç·à≠·çç·à≠': [{ i: '·ã®·å•·â•·àµ ·àµ·åã', q: 1/7 }], '·àµ·åã ·çç·à≠·çç·à≠': [{ i: '·ã®·å•·â•·àµ ·àµ·åã', q: 1/10 }]
    };

    let sel = null, isAdmin = false, dailyListener = null, monthlyListener = null, adjustmentListener = null, stockState = {};
    
    // GLOBAL STATE VARIABLES
    let manualStats = { f: 0, b: 0, abs_a: false, abs_f: false }; 
    let dailyTotals = { f: 0, b: 0 }; 
    let monthAdjustments = {};
    let monthlySnap = null;

    window.onload = () => {
        document.getElementById('work-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('work-date').onchange = sync;
        setupAccordions(); renderMenu(); renderRestockInputs();
        auth.onAuthStateChanged(user => {
            isAdmin = (user && user.uid === adminUID);
            
            document.getElementById('admin-month-card').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('admin-manual-control').style.display = isAdmin ? 'grid' : 'none'; 
            document.getElementById('auth-btn').innerText = isAdmin ? "Logout Admin" : "Admin Login";
            document.getElementById('print-btn').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('admin-stock-wrapper').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('restock-log-container').style.display = isAdmin ? 'block' : 'none';
            
            sync();
        });
    };

    function setupAccordions() {
        const acc = document.getElementsByClassName("accordion");
        for (let i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                const panel = this.nextElementSibling;
                if (panel.style.maxHeight) { panel.style.maxHeight = null; panel.classList.remove('show'); } 
                else { panel.classList.add('show'); panel.style.maxHeight = panel.scrollHeight + "px"; }
            });
        }
    }

    function renderMenu() {
        MENU.forEach(i => {
            const btn = document.createElement('div');
            btn.className = `menu-btn ${['fasting','nonfast'].includes(i.c) ? 'food-btn' : (i.c=='add'?'add-btn':'')}`;
            btn.innerHTML = `<strong>${i.n}</strong><br><small>${i.p} ETB</small>`;
            btn.onclick = () => { sel = i; document.getElementById('m-item').innerText = i.n; document.getElementById('qty-modal').style.display='flex'; };
            document.getElementById('grid-' + i.c).appendChild(btn);
        });
    }

    function renderRestockInputs() {
        const container = document.getElementById('restock-container');
        INVENTORY_ITEMS.forEach((name, idx) => {
            const row = document.createElement('div');
            row.className = 'inv-row';
            row.innerHTML = `<span class="inv-name">${name}</span><input type="number" id="inv-in-${idx}" class="inv-in" placeholder="+ Add"><button class="inv-btn" id="inv-btn-${idx}" onclick="addRestock('${name}', 'inv-in-${idx}', 'inv-btn-${idx}')">Add</button>`;
            container.appendChild(row);
        });
    }

    async function addRestock(itemName, inputId, btnId) {
        const qty = parseFloat(document.getElementById(inputId).value); if(!qty) return;
        const btn = document.getElementById(btnId); btn.innerText = '...';
        await db.collection('transactions').add({ n: `Restock: ${itemName}`, q: qty, p: 0, d: document.getElementById('work-date').value, ex: false, type: 'restock', itemRef: itemName, ts: Date.now() });
        btn.innerText = 'Added'; setTimeout(() => { btn.innerText = 'Add'; document.getElementById(inputId).value = ''; }, 1000);
    }

    async function confirmSale() {
        const q = parseInt(document.getElementById('m-qty').value); if(!q) return;
        await db.collection('transactions').add({ n: sel.n, q: q, p: sel.p * q, d: document.getElementById('work-date').value, ex: false, ts: Date.now() });
        closeModal();
    }

    async function saveEx() {
        const n = document.getElementById('ex-name').value, p = parseFloat(document.getElementById('ex-amt').value); if(!n || !p) return;
        await db.collection('transactions').add({ n: "OUT: " + n, q: 1, p: p, d: document.getElementById('work-date').value, ex: true, ts: Date.now() });
        document.getElementById('ex-name').value = ''; document.getElementById('ex-amt').value = '';
    }

    async function saveRev() {
        const n = document.getElementById('rev-name').value, p = parseFloat(document.getElementById('rev-amt').value); if(!n || !p) return;
        await db.collection('transactions').add({ n: "IN: " + n, q: 1, p: p, d: document.getElementById('work-date').value, ex: false, ts: Date.now() });
        document.getElementById('rev-name').value = ''; document.getElementById('rev-amt').value = '';
    }

    async function saveNightStats() {
        const date = document.getElementById('work-date').value;
        const f = parseInt(document.getElementById('manual-night-food').value) || 0;
        const b = parseInt(document.getElementById('manual-night-buna').value) || 0;
        const abs_a = document.getElementById('absent-amelewerk').checked;
        const abs_f = document.getElementById('absent-frehiwot').checked;
        
        await db.collection('adjustments').doc(date).set({ f: f, b: b, abs_a: abs_a, abs_f: abs_f }, { merge: true });
        alert("Night Stats & Attendance Saved!");
    }

    function updateDailyIncentive() {
        let n_food_qty = manualStats.f || 0;
        let n_buna_qty = manualStats.b || 0;
        let norm_food_qty = dailyTotals.f - n_food_qty;
        let norm_buna_qty = dailyTotals.b - n_buna_qty;
        if(norm_food_qty < 0) norm_food_qty = 0; 
        if(norm_buna_qty < 0) norm_buna_qty = 0;

        let inc_norm = 0;
        if (norm_food_qty > 25 && norm_buna_qty > 45) {
            inc_norm = ((norm_food_qty - 25) * 7.3) + ((norm_buna_qty - 45) * 4.1);
        }
        let inc_night = (n_food_qty * 25) + (n_buna_qty * 10);
        document.getElementById('daily-incentive').innerText = (inc_norm + inc_night).toFixed(2);
        document.getElementById('d-inc-norm').innerText = inc_norm.toFixed(1);
        document.getElementById('d-inc-night').innerText = inc_night.toFixed(1);
    }

    function updateMonthlyIncentive() {
        if(!monthlySnap) return;
        let mNet = 0, dStats = {};
        
        monthlySnap.forEach(doc => {
            const t = doc.data(); if(t.type === 'restock') return;
            if(t.ex) mNet -= t.p; else mNet += t.p;
            if(!t.ex) {
                if(!dStats[t.d]) dStats[t.d] = { total_f:0, total_b:0 };
                if(FOOD_SET.has(t.n)) dStats[t.d].total_f += t.q;
                if(t.n === '·â°·äì') dStats[t.d].total_b += t.q;
            }
        });

        let mInc = 0, amelewerk_loss = 0, frehiwot_loss = 0;
        const allDays = new Set([...Object.keys(dStats), ...Object.keys(monthAdjustments)]);

        allDays.forEach(dayKey => {
            const day = dStats[dayKey] || { total_f:0, total_b:0 };
            const adj = monthAdjustments[dayKey] || { f:0, b:0, abs_a:false, abs_f:false };
            
            let n_f = adj.f || 0, n_b = adj.b || 0;
            let norm_f = day.total_f - n_f, norm_b = day.total_b - n_b;
            if(norm_f < 0) norm_f = 0; if(norm_b < 0) norm_b = 0;

            let nightTotal = (n_f * 25) + (n_b * 10);
            mInc += nightTotal;
            if(norm_f > 25 && norm_b > 45) mInc += ((norm_f - 25) * 7.3) + ((norm_b - 45) * 4.1);

            let share = nightTotal / 2;
            if(adj.abs_a) amelewerk_loss -= share;
            if(adj.abs_f) frehiwot_loss -= share;
        });

        document.getElementById('month-n').innerText = mNet.toLocaleString() + " ETB";
        document.getElementById('month-incentive').innerText = mInc.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}) + " ETB";
        document.getElementById('bal-ame').innerText = amelewerk_loss.toFixed(2);
        document.getElementById('bal-fre').innerText = frehiwot_loss.toFixed(2);
    }

    // --- CRITICAL DATE HELPER ---
    function getSafeYesterday(dateStr) {
        let parts = dateStr.split('-');
        let y = parseInt(parts[0]);
        let m = parseInt(parts[1]) - 1; 
        let d = parseInt(parts[2]);
        
        let dateObj = new Date(y, m, d);
        dateObj.setDate(dateObj.getDate() - 1);
        
        let yy = dateObj.getFullYear();
        let mm = String(dateObj.getMonth() + 1).padStart(2, '0');
        let dd = String(dateObj.getDate()).padStart(2, '0');
        
        return `${yy}-${mm}-${dd}`;
    }

    async function sync() {
        const date = document.getElementById('work-date').value;
        if(dailyListener) dailyListener();
        if(adjustmentListener) adjustmentListener();
        if(monthlyListener) monthlyListener();

        stockState = {}; 
        INVENTORY_ITEMS.forEach(i => stockState[i] = { yest: 0, added: 0, used: 0 });

        const yestStr = getSafeYesterday(date);
        
        try {
            const yestSnap = await db.collection('inventory').where('d', '==', yestStr).get();
            if(!yestSnap.empty) {
                yestSnap.forEach(doc => { 
                    const d = doc.data(); 
                    if(stockState[d.n]) stockState[d.n].yest = parseFloat(d.left); 
                });
            }
        } catch(err) { console.error(err); }

        renderInventoryTable();

        adjustmentListener = db.collection('adjustments').doc(date).onSnapshot(doc => {
            if (doc.exists) {
                manualStats = doc.data();
                document.getElementById('manual-night-food').value = manualStats.f || 0;
                document.getElementById('manual-night-buna').value = manualStats.b || 0;
                document.getElementById('absent-amelewerk').checked = manualStats.abs_a || false;
                document.getElementById('absent-frehiwot').checked = manualStats.abs_f || false;
            } else {
                manualStats = { f: 0, b: 0, abs_a: false, abs_f: false };
                document.getElementById('manual-night-food').value = 0;
                document.getElementById('manual-night-buna').value = 0;
                document.getElementById('absent-amelewerk').checked = false;
                document.getElementById('absent-frehiwot').checked = false;
            }
            monthAdjustments[date] = manualStats;
            updateDailyIncentive();
            updateMonthlyIncentive();
        });

        dailyListener = db.collection('transactions').where('d', '==', date).onSnapshot(snap => {
            let s=0, e=0, totalPlates=0;
            dailyTotals.f = 0; dailyTotals.b = 0;
            
            INVENTORY_ITEMS.forEach(i => { stockState[i].added = 0; stockState[i].used = 0; });
            
            let html='', reportMap = {}, restockMap = {};

            snap.forEach(doc => {
                const t = doc.data();
                if(t.type === 'restock') {
                    if(stockState[t.itemRef]) stockState[t.itemRef].added += t.q; 
                    if(!restockMap[t.itemRef]) restockMap[t.itemRef] = 0;
                    restockMap[t.itemRef] += t.q;
                } else {
                    if(t.ex) e += t.p; else s += t.p;
                    if (!t.ex) {
                        if (FOOD_SET.has(t.n)) { totalPlates += t.q; dailyTotals.f += t.q; }
                        if (t.n === '·â°·äì') { dailyTotals.b += t.q; }
                        if(RECIPES[t.n]) {
                            RECIPES[t.n].forEach(ins => { 
                                if(stockState[ins.i]) stockState[ins.i].used += (ins.q * t.q); 
                            });
                        }
                    }
                }

                if (t.type !== 'restock') {
                    const color = t.ex ? 'red' : (t.n.startsWith('IN:') ? 'green' : 'black');
                    if(!reportMap[t.n]) reportMap[t.n] = { q:0, p:0, c: color, isMenu: MENU.some(m => m.n === t.n), isExpense: t.ex };
                    reportMap[t.n].q += t.q;
                    reportMap[t.n].p += t.p;
                }
            });

            Object.keys(reportMap).sort().forEach(itemName => {
                const item = reportMap[itemName];
                let actions = '';
                if (isAdmin) {
                    actions += `<button onclick="adjustItemTotal('${itemName}', ${item.q}, ${item.p}, ${item.isMenu}, ${item.isExpense})" style="padding:2px 8px; cursor:pointer;">‚úèÔ∏è</button>`;
                    if (!item.isMenu) actions += `<button onclick="deleteTransaction('${itemName}')" style="padding:2px 8px; cursor:pointer; color:red;">‚ùå</button>`;
                }
                html += `<tr><td style="color:${item.c};">${itemName}</td><td>${item.q}</td><td>${item.p}</td><td class="no-print">${actions}</td></tr>`;
            });
            document.getElementById('log-body').innerHTML = html;

            let restockHtml = '';
            Object.keys(restockMap).sort().forEach(itemName => {
                let qty = restockMap[itemName];
                restockHtml += `<tr><td>${itemName}</td><td>${qty.toFixed(2)}</td><td><button onclick="adjustRestockTotal('${itemName}', ${qty})">Edit</button></td></tr>`;
            });
            document.getElementById('restock-log-body').innerHTML = restockHtml;

            document.getElementById('total-s').innerText = s;
            document.getElementById('total-e').innerText = e;
            document.getElementById('total-n').innerText = (s - e) + " ETB";
            document.getElementById('total-plates').innerText = totalPlates;

            updateDailyIncentive();
            renderInventoryTable();
        });

        const year = date.split('-')[0], month = date.split('-')[1];
        const mAdjSnap = await db.collection('adjustments').where(firebase.firestore.FieldPath.documentId(), '>=', `${year}-${month}-01`).where(firebase.firestore.FieldPath.documentId(), '<=', date).get();
        monthAdjustments = {}; 
        mAdjSnap.forEach(doc => { monthAdjustments[doc.id] = doc.data(); });
        monthlyListener = db.collection('transactions').where('d', '>=', `${year}-${month}-01`).where('d', '<=', date).onSnapshot(snap => {
            monthlySnap = snap; 
            updateMonthlyIncentive();
        });
    }

    function renderInventoryTable() {
        let html = '', printHtml = '';
        INVENTORY_ITEMS.forEach(name => {
            const i = stockState[name];
            const current = (i.yest + i.added - i.used);
            let leftDisplay = current.toFixed(2);
            if (isAdmin && MANUAL_LINK_ITEMS.includes(name)) {
                leftDisplay = `<span class="admin-edit-link" onclick="adjustLiveInventory('${name}', ${current})">${current.toFixed(2)}</span>`;
            }
            html += `<tr><td>${name}</td><td>${i.yest.toFixed(2)}</td><td style="color:green;">+${i.added}</td><td style="color:red;">-${i.used.toFixed(2)}</td><td class="stock-curr">${leftDisplay}</td></tr>`;
            printHtml += `<tr><td>${name}</td><td>${(i.yest + i.added).toFixed(2)}</td><td>${i.used.toFixed(2)}</td><td>${current.toFixed(2)}</td></tr>`;
        });
        document.getElementById('live-inv-body').innerHTML = html;
        document.getElementById('print-inv-body').innerHTML = printHtml;
    }

    async function deleteTransaction(itemName) {
        if(!confirm(`Delete: ${itemName}?`)) return;
        const date = document.getElementById('work-date').value;
        const snapshot = await db.collection('transactions').where('d', '==', date).where('n', '==', itemName).get();
        const batch = db.batch(); snapshot.forEach(doc => batch.delete(doc.ref)); await batch.commit();
    }

    async function adjustItemTotal(itemName, q, p, isMenu, ex) {
        if (isMenu) {
            let nq = prompt(`Qty (curr: ${q}):`, q); if (nq === null) return; nq = parseInt(nq);
            const d = nq - q; if(d === 0) return;
            const mo = MENU.find(m => m.n === itemName);
            await db.collection('transactions').add({ n: itemName, q: d, p: d * (mo ? mo.p : 0), d: document.getElementById('work-date').value, ex: false, ts: Date.now() });
        } else {
            let np = prompt(`Total (curr: ${p}):`, p); if (np === null) return; np = parseFloat(np);
            const d = np - p; if (Math.abs(d) < 0.01) return;
            await db.collection('transactions').add({ n: itemName, q: 0, p: d, d: document.getElementById('work-date').value, ex: ex, ts: Date.now() });
        }
    }

    async function adjustRestockTotal(itemName, q) {
        let nq = prompt(`Restock (curr: ${q}):`, q); if (nq === null) return; nq = parseFloat(nq);
        const d = nq - q; if (Math.abs(d) < 0.001) return;
        await db.collection('transactions').add({ n: `Restock Adj: ${itemName}`, q: d, p: 0, d: document.getElementById('work-date').value, ex: false, type: 'restock', itemRef: itemName, ts: Date.now() });
    }

    async function adjustLiveInventory(itemName, cur) {
        let actual = prompt(`Manual Count for ${itemName}:\nSystem: ${cur}\nActual:`);
        if(actual === null) return; actual = parseFloat(actual);
        const d = actual - cur; if(Math.abs(d) < 0.01) return;
        await db.collection('transactions').add({ n: `Manual Adj: ${itemName}`, q: d, p: 0, d: document.getElementById('work-date').value, ex: false, type: 'restock', itemRef: itemName, ts: Date.now() });
    }

    function initiateFinalize() {
        document.getElementById('pdf-date').innerText = "DATE: " + document.getElementById('work-date').value;
        window.print();
        setTimeout(() => { if(confirm("Save stock and clear today?")) finalizeDay(); }, 1500);
    }

    async function finalizeDay() {
        const date = document.getElementById('work-date').value;
        const batch = db.batch();
        INVENTORY_ITEMS.forEach(name => {
            const i = stockState[name];
            batch.set(db.collection('inventory').doc(`${date}_${name.replace(/\s/g,'')}`), { n: name, left: (i.yest + i.added - i.used), d: date, ts: Date.now() });
        });
        const tSnap = await db.collection('transactions').where('d', '==', date).get(); 
        tSnap.forEach(d => batch.delete(d.ref));
        await batch.commit(); 
        alert("Day Finalized."); location.reload();
    }

    async function handleAuth() {
        if(auth.currentUser) { auth.signOut(); } 
        else { const email = prompt("Email:"), pass = prompt("Pass:"); if(email && pass) await auth.signInWithEmailAndPassword(email, pass).catch(err => alert(err.message)); }
    }
    function closeModal() { document.getElementById('qty-modal').style.display='none'; document.getElementById('m-qty').value = 1; }
</script>

</body>
</html>
